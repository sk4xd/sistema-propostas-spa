
<div>
  <div class="row" style="flex-direction: row-reverse;">
    <span (click)="closeModal()" type="button" class="btn-close" aria-label="Close" style="cursor: pointer;"></span>
  </div>
  <div class="row" style="justify-content: space-between;">
    <h3 class="col-md-6">
      Proposta
    </h3>
    <h3 *ngIf="proposal.id" class="col-md-6" style="text-align: center;">
      Código: {{proposal.id}}
    </h3>
  </div>
  <form [formGroup]="form" (ngSubmit)="saveProposal()">
    <div class="row">
      <div *ngIf="editing" class="form-group col-md-6">
        <label for="status">Status Proposta</label>
        <select type="text" formControlName="status" id="status" class="form-control">
          <option value="">Selecione</option>
          <option *ngFor="let status of statuses" [value]="status.id">{{status.status_description}}</option>
        </select>
      </div>
      <div class="row">
        <div class="form-group col-md-6">
          <label for="customer">Cliente</label>
          <ng-multiselect-dropdown
            [data]="customers"
            [(ngModel)]="selectedCustomer"
            formControlName="customer"
            [settings]="customerDropdownSettings"
          >
          </ng-multiselect-dropdown>
        </div>
        <div class="form-group col-md-6" style="display: flex; align-self: end;">
          <button type="button" [disabled]="selectedCustomer.length !== 1" class="btn btn-primary" (click)="openCustomerInfo()">Informações</button>
        </div>
      </div>
      <div class="form-group col-md-8">
        <label for="contractType">Tipo do contrato</label>
        <select formControlName="contract_type" type="text" class="form-control" id="contractType">
          <option value="">Selecione</option>
          <option value="Novo">Novo</option>
          <option value="Portabilidade">Portabilidade</option>
          <option value="Refinanciamento">Refinanciamento</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="form-group ">
        <label for="operationData">Dados da operação e Informações adicionais</label>
        <textarea formControlName="operation_data" maxlength="4000" type="text" class="form-control" id="operationData">
        </textarea>
      </div>
    </div>
    <div class="row">
      <div class="form-group">
        <label for="filedescription">Informação uploads</label>
        <input
            formControlName="file_description"
            id="filedescription"
            type="text"
            class="form-control">
        <div *ngIf="f.file_description.touched && f.file_description.invalid" class="alert alert-danger">
            <div *ngIf="f.file_description.errors && f.file_description.errors.required">Informação uploads is required.</div>
            <div *ngIf="f.file_description.errors && f.file_description.errors.minlength">Informação uploads should be 3 character.</div>
        </div>
      </div>
      <div class="form-group col-md-3">
          <label for="files">Arquivos: ({{ uploads.length + myFiles.length }})</label>
          <input
              style="width: 9rem"
              formControlName="files"
              id="files"
              type="file"
              multiple
              class="form-control"
              (change)="onFileChange($event)">
          <div *ngIf="f.files.touched && f.files.invalid" class="alert alert-danger">
              <div *ngIf="f.files.errors && f.files.errors.required">Files is required.</div>
          </div>
      </div>
      <div class="form-group col-md-4" style="display: flex; align-self: end;">
        <button type="button" [disabled]="uploads.length <= 0 && myFiles.length <= 0" class="btn btn-primary" (click)="openUploadsInfo()">Detalhes downloads</button>
      </div>
    </div>
    <div *ngIf="proposal.id && editing">
      <div *ngIf="form.controls['status'].value === '4'">
        <div class="row">
          <div class="form-group col-md-6">
            <label for="institute">Instituição</label>
            <ng-multiselect-dropdown
              [settings]="institutesDropdownSettings"
              [data]="institutes"
              [(ngModel)]="selectedInstitute"
              formControlName="institute"
            >
            </ng-multiselect-dropdown>
          </div>
        </div>
        <div class="row">
          <div class="form-group col-md-6">
            <label for="finalValue">Valor final</label>
            <input type="text" formControlName="final_value" prefix="R$ " [allowNegativeNumbers]="false" mask="separator.2" thousandSeparator="." id="finalValue" class="form-control">
          </div>
          <div class="form-group col-md-6">
            <label for="fee">Taxa</label>
            <input type="text"
            formControlName="fee"
            id="fee"
            class="form-control"
            suffix=" %"
            [allowNegativeNumbers]="false"
            thousandSeparator="."
            mask="separator.2">
          </div>
        </div>
        <div class="row">
          <div class="form-group col-md-6">
            <label for="comissionValue">Valor comissão</label>
            <input type="text"
              formControlName="comission_value"
              id="comissionValue"
              class="form-control"
              prefix="R$ "
              [allowNegativeNumbers]="false"
              mask="separator.2"
              thousandSeparator=".">
          </div>
          <div class="form-group col-md-6">
            <label for="comissionPercentage">Porcentagem comissão</label>
            <input type="text"
              readonly
              formControlName="comission_percentage"
              id="comissionPercentage"
              class="form-control"
              suffix=" %"
              [dropSpecialCharacters]="false"
              mask="percent.2">
          </div>
          <div>
            <div *ngIf="form.hasError('invalidComission')" class="alert alert-danger" style="margin-top: 3px;">
              Valor da comissão não pode ser maior que o valor final
            </div>
          </div>
        </div>

        <div class="row">
          <div class="row">
            <div class="form-group col-md-6">
              <label for="contractStatus">Status contrato</label>
              <select type="text" formControlName="contract_status" id="contractStatus" class="form-control">
                <option value="">Selecione</option>
                <option value="1">Enviado</option>
                <option value="2">Assinado</option>
                <option value="3">Pago</option>
              </select>
            </div>
          </div>
          <div *ngIf="!proposal.contract_upload" class="form-group col-md-8">
            <label for="contractUpload">Upload Contrato</label>
            <input
              formControlName="contract_upload"
              id="contractUpload"
              type="file"
              class="form-control"
              (change)="onContractChange($event)"
            >
          </div>
        </div>
        <div *ngIf="proposal.contract_upload" class="row">
          <div class="form-group col-md-10">
            <label for="contractLink">Download do Contrato</label>
            <a class="form-control link-primary" style="cursor: pointer;" id="contractLink" (click)="downloadContract()">{{ proposal.contract_upload }}</a>
          </div>
          <div class="form-group col-md-2" style="display: flex; align-self: end;">
            <button type="button" class="btn btn-secondary icofont-trash" (click)="removeContract()"></button>
          </div>
        </div>

        <div class="row">
          <div class="form-group col-md-12">
            <label for="contractDescription">Informações do contrato</label>
            <textarea type="text" formControlName="contract_description" id="contractDescription" class="form-control"></textarea>
          </div>
        </div>
      </div>
      <div *ngIf="form.controls['status'].value === '5'" class="form-group">
        <label for="reprovalDescription">Motivo reprovação</label>
        <textarea formControlName="reproval_description" type="text" class="form-control" id="reprovalDescription"></textarea>
      </div>
    </div>
    <div class="form-group" style="margin-top: 1em; display: flex; justify-content: space-between;">
      <button type="button" (click)="onNoClick()" class="btn btn-secondary">Sair</button>
      <button [disabled]="form.invalid" type="submit" class="btn btn-primary">Salvar</button>
    </div>
  </form>
</div>
